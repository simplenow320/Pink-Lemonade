{% extends "base.html" %}

{% block title %}{{ grant.title }} - Pink Lemonade{% endblock %}

{% block extra_css %}
<style>
  .detail-card {
    background: white;
    border-radius: 16px;
    padding: 32px;
    border: 1px solid #E8E8E8;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    margin-bottom: 24px;
  }
  
  .fit-badge {
    background: linear-gradient(135deg, #B8899A, #D4BAC7);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-block;
  }
  
  .btn-primary {
    background: #B8899A;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-primary:hover {
    background: #A67A8A;
    color: white;
    text-decoration: none;
  }
  
  .btn-outline {
    background: white;
    color: #B8899A;
    padding: 12px 24px;
    border: 1px solid #B8899A;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-outline:hover {
    background: #B8899A;
    color: white;
    text-decoration: none;
  }
  
  .btn-secondary {
    background: #6B6B6B;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-secondary:hover {
    background: #4A4A4A;
    color: white;
  }
  
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
    margin: 24px 0;
  }
  
  .contact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 24px 0;
  }
  
  .info-item {
    padding: 16px;
    background: #F8F9FA;
    border-radius: 8px;
  }
  
  .contact-item {
    padding: 12px 16px;
    background: #FAFAFA;
    border-radius: 8px;
    border: 1px solid #F0F0F0;
    transition: all 0.2s ease;
  }
  
  .contact-item:hover {
    border-color: #B8899A;
    background: white;
  }
  
  .info-label {
    color: #6B6B6B;
    font-size: 0.9rem;
    margin-bottom: 4px;
  }
  
  .info-value {
    color: #2A2A2A;
    font-weight: 500;
    font-size: 1.1rem;
  }
  
  .contact-label {
    color: #6B6B6B;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .contact-value {
    color: #2A2A2A;
    font-weight: 500;
    font-size: 1rem;
    word-break: break-word;
  }
  
  .contact-value a {
    color: #B8899A;
    text-decoration: none;
  }
  
  .contact-value a:hover {
    text-decoration: underline;
  }
  
  .edit-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #E8E8E8;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: white;
  }
  
  .edit-input:focus {
    outline: none;
    border-color: #B8899A;
    box-shadow: 0 0 0 3px rgba(184, 137, 154, 0.1);
  }
  
  .edit-input.error {
    border-color: #dc3545;
  }
  
  .error-message {
    color: #dc3545;
    font-size: 0.85rem;
    margin-top: 4px;
    display: none;
  }
  
  .confidence-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-block;
    margin-left: 8px;
  }
  
  .confidence-high {
    background: #D4EDDA;
    color: #155724;
  }
  
  .confidence-medium {
    background: #FFF3CD;
    color: #856404;
  }
  
  .confidence-low {
    background: #F8D7DA;
    color: #721C24;
  }
  
  .edit-mode-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  
  .icon {
    width: 16px;
    height: 16px;
    display: inline-block;
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
  <!-- Back Button -->
  <div style="margin-bottom: 20px;">
    <a href="/opportunities" class="btn-outline">← Back to Opportunities</a>
  </div>
  
  <!-- Grant Header -->
  <div class="detail-card">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
      <div style="flex: 1;">
        <h1 style="font-size: 2rem; font-weight: 700; color: #2A2A2A; margin: 0 0 8px 0; line-height: 1.2;">
          {{ grant.title }}
        </h1>
        <p style="font-size: 1.2rem; color: #6B6B6B; margin: 0; font-weight: 500;">{{ grant.funder }}</p>
      </div>
      {% if grant.match_score %}
      <div class="fit-badge">
        {{ grant.match_score }}/5 ★
      </div>
      {% endif %}
    </div>
    
    <!-- Grant Info Grid -->
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">Funding Amount</div>
        <div class="info-value">
          {% if grant.amount_min and grant.amount_max %}
            ${{ "{:,}".format(grant.amount_min|int) }} - ${{ "{:,}".format(grant.amount_max|int) }}
          {% elif grant.amount_min %}
            ${{ "{:,}".format(grant.amount_min|int) }}+
          {% elif grant.amount_max %}
            Up to ${{ "{:,}".format(grant.amount_max|int) }}
          {% else %}
            Not specified
          {% endif %}
        </div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Application Deadline</div>
        <div class="info-value">
          {% if grant.deadline %}
            {{ grant.deadline.strftime('%B %d, %Y') }}
          {% else %}
            Rolling deadline
          {% endif %}
        </div>
      </div>
      
      {% if grant.geography %}
      <div class="info-item">
        <div class="info-label">Location</div>
        <div class="info-value">{{ grant.geography }}</div>
      </div>
      {% endif %}
      
      {% if grant.source_name %}
      <div class="info-item">
        <div class="info-label">Source</div>
        <div class="info-value">{{ grant.source_name }}</div>
      </div>
      {% endif %}
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 16px; margin-top: 24px;">
      <button onclick="saveGrant({{ grant.id }})" class="btn-outline">Save Grant</button>
      {% if grant.link %}
      <a href="{{ grant.link }}" target="_blank" class="btn-primary">View Application Details</a>
      {% else %}
      <button onclick="createApplication({{ grant.id }})" class="btn-primary">Start Application</button>
      {% endif %}
    </div>
  </div>
  
  <!-- Contact Information Card -->
  <div class="detail-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="font-size: 1.4rem; font-weight: 600; color: #2A2A2A; margin: 0;">
        Contact Information
        {% if grant.contact_confidence %}
        <span class="confidence-badge confidence-{{ grant.contact_confidence }}">
          {{ grant.contact_confidence }} confidence
        </span>
        {% endif %}
      </h2>
      <button id="editContactBtn" onclick="toggleEditMode()" class="btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">
        <span id="editBtnText">✏️ Edit Contact Info</span>
      </button>
    </div>
    
    <!-- View Mode -->
    <div id="viewMode" class="contact-grid">
      <div class="contact-item">
        <div class="contact-label">
          <svg class="icon" fill="#6B6B6B" viewBox="0 0 20 20">
            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
          </svg>
          Contact Name
        </div>
        <div class="contact-value">{{ grant.contact_name or 'Not available' }}</div>
      </div>
      
      <div class="contact-item">
        <div class="contact-label">
          <svg class="icon" fill="#6B6B6B" viewBox="0 0 20 20">
            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
          </svg>
          Email
        </div>
        <div class="contact-value">
          {% if grant.contact_email %}
            <a href="mailto:{{ grant.contact_email }}">{{ grant.contact_email }}</a>
          {% else %}
            Not available
          {% endif %}
        </div>
      </div>
      
      <div class="contact-item">
        <div class="contact-label">
          <svg class="icon" fill="#6B6B6B" viewBox="0 0 20 20">
            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
          </svg>
          Phone
        </div>
        <div class="contact-value">
          {% if grant.contact_phone %}
            <a href="tel:{{ grant.contact_phone }}">{{ grant.contact_phone }}</a>
          {% else %}
            Not available
          {% endif %}
        </div>
      </div>
      
      <div class="contact-item">
        <div class="contact-label">
          <svg class="icon" fill="#6B6B6B" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"/>
          </svg>
          Department
        </div>
        <div class="contact-value">{{ grant.contact_department or 'Not available' }}</div>
      </div>
      
      <div class="contact-item">
        <div class="contact-label">
          <svg class="icon" fill="#6B6B6B" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.083 9h1.946c.089-1.546.383-2.97.837-4.118A6.004 6.004 0 004.083 9zM10 2a8 8 0 100 16 8 8 0 000-16zm0 2c-.076 0-.232.032-.465.262-.238.234-.497.623-.737 1.182-.389.907-.673 2.142-.766 3.556h3.936c-.093-1.414-.377-2.649-.766-3.556-.24-.56-.5-.948-.737-1.182C10.232 4.032 10.076 4 10 4zm3.971 5c-.089-1.546-.383-2.97-.837-4.118A6.004 6.004 0 0115.917 9h-1.946zm-2.003 2H8.032c.093 1.414.377 2.649.766 3.556.24.56.5.948.737 1.182.233.23.389.262.465.262.076 0 .232-.032.465-.262.238-.234.498-.623.737-1.182.389-.907.673-2.142.766-3.556zm1.166 4.118c.454-1.147.748-2.572.837-4.118h1.946a6.004 6.004 0 01-2.783 4.118zm-6.268 0C6.412 13.97 6.118 12.546 6.029 11H4.083a6.004 6.004 0 002.783 4.118z" clip-rule="evenodd"/>
          </svg>
          Organization Website
        </div>
        <div class="contact-value">
          {% if grant.organization_website %}
            <a href="{{ grant.organization_website }}" target="_blank">{{ grant.organization_website }}</a>
          {% else %}
            Not available
          {% endif %}
        </div>
      </div>
      
      <div class="contact-item">
        <div class="contact-label">
          <svg class="icon" fill="#6B6B6B" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
          </svg>
          Application URL
        </div>
        <div class="contact-value">
          {% if grant.application_url %}
            <a href="{{ grant.application_url }}" target="_blank">{{ grant.application_url }}</a>
          {% else %}
            Not available
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Edit Mode -->
    <div id="editMode" style="display: none;" class="contact-grid">
      <div>
        <label class="contact-label">Contact Name</label>
        <input type="text" id="contactName" class="edit-input" value="{{ grant.contact_name or '' }}" placeholder="Enter contact name">
      </div>
      
      <div>
        <label class="contact-label">Email</label>
        <input type="email" id="contactEmail" class="edit-input" value="{{ grant.contact_email or '' }}" placeholder="example@organization.org">
        <div id="emailError" class="error-message">Please enter a valid email address</div>
      </div>
      
      <div>
        <label class="contact-label">Phone</label>
        <input type="tel" id="contactPhone" class="edit-input" value="{{ grant.contact_phone or '' }}" placeholder="(555) 123-4567">
        <div id="phoneError" class="error-message">Please enter a valid phone number</div>
      </div>
      
      <div>
        <label class="contact-label">Department</label>
        <input type="text" id="contactDepartment" class="edit-input" value="{{ grant.contact_department or '' }}" placeholder="Grant Department">
      </div>
      
      <div>
        <label class="contact-label">Organization Website</label>
        <input type="url" id="organizationWebsite" class="edit-input" value="{{ grant.organization_website or '' }}" placeholder="https://example.org">
        <div id="websiteError" class="error-message">Please enter a valid URL</div>
      </div>
      
      <div>
        <label class="contact-label">Application URL</label>
        <input type="url" id="applicationUrl" class="edit-input" value="{{ grant.application_url or '' }}" placeholder="https://example.org/apply">
        <div id="appUrlError" class="error-message">Please enter a valid URL</div>
      </div>
    </div>
    
    <!-- Edit Mode Actions -->
    <div id="editActions" class="edit-mode-actions" style="display: none;">
      <button onclick="saveContactInfo()" class="btn-primary">Save Changes</button>
      <button onclick="cancelEdit()" class="btn-secondary">Cancel</button>
    </div>
  </div>
  
  <!-- Grant Description/Eligibility -->
  {% if grant.eligibility %}
  <div class="detail-card">
    <h2 style="font-size: 1.4rem; font-weight: 600; color: #2A2A2A; margin: 0 0 16px 0;">Eligibility & Description</h2>
    <div style="color: #4A4A4A; line-height: 1.6;">
      {{ grant.eligibility|safe }}
    </div>
  </div>
  {% endif %}
  
  <!-- Match Reasoning -->
  {% if grant.match_reason %}
  <div class="detail-card">
    <h2 style="font-size: 1.4rem; font-weight: 600; color: #2A2A2A; margin: 0 0 16px 0;">Why This Grant Fits Your Organization</h2>
    <div style="color: #4A4A4A; line-height: 1.6;">
      {{ grant.match_reason }}
    </div>
  </div>
  {% endif %}
  
  <!-- Grant Status -->
  <div class="detail-card">
    <h2 style="font-size: 1.4rem; font-weight: 600; color: #2A2A2A; margin: 0 0 16px 0;">Application Status</h2>
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="padding: 6px 12px; background: #E3F2FD; color: #1976D2; border-radius: 16px; font-size: 0.9rem; text-transform: capitalize;">
        {{ grant.status }}
      </span>
      {% if grant.created_at %}
      <span style="color: #6B6B6B; font-size: 0.9rem;">
        Added {{ grant.created_at.strftime('%B %d, %Y') }}
      </span>
      {% endif %}
    </div>
  </div>
</div>

<!-- Toast notification -->
<div id="toast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#B8899A;color:white;padding:12px 20px;border-radius:8px;display:none;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
  <span id="toastMessage"></span>
</div>

<script>
let editMode = false;
const grantId = {{ grant.id }};

function toggleEditMode() {
  editMode = !editMode;
  
  if (editMode) {
    document.getElementById('viewMode').style.display = 'none';
    document.getElementById('editMode').style.display = 'grid';
    document.getElementById('editActions').style.display = 'flex';
    document.getElementById('editBtnText').textContent = '👁️ View Mode';
  } else {
    document.getElementById('viewMode').style.display = 'grid';
    document.getElementById('editMode').style.display = 'none';
    document.getElementById('editActions').style.display = 'none';
    document.getElementById('editBtnText').textContent = '✏️ Edit Contact Info';
    clearErrors();
  }
}

function cancelEdit() {
  toggleEditMode();
  clearErrors();
}

function clearErrors() {
  document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.edit-input').forEach(el => el.classList.remove('error'));
}

function validateEmail(email) {
  if (!email) return true; // Allow empty
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  if (!phone) return true; // Allow empty
  const re = /^[\d\s\-\(\)\+\.]+$/;
  return re.test(phone) && phone.replace(/\D/g, '').length >= 10;
}

function validateUrl(url) {
  if (!url) return true; // Allow empty
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

async function saveContactInfo() {
  clearErrors();
  
  const contactData = {
    contact_name: document.getElementById('contactName').value.trim(),
    contact_email: document.getElementById('contactEmail').value.trim(),
    contact_phone: document.getElementById('contactPhone').value.trim(),
    contact_department: document.getElementById('contactDepartment').value.trim(),
    organization_website: document.getElementById('organizationWebsite').value.trim(),
    application_url: document.getElementById('applicationUrl').value.trim()
  };
  
  // Validate fields
  let hasErrors = false;
  
  if (contactData.contact_email && !validateEmail(contactData.contact_email)) {
    document.getElementById('contactEmail').classList.add('error');
    document.getElementById('emailError').style.display = 'block';
    hasErrors = true;
  }
  
  if (contactData.contact_phone && !validatePhone(contactData.contact_phone)) {
    document.getElementById('contactPhone').classList.add('error');
    document.getElementById('phoneError').style.display = 'block';
    hasErrors = true;
  }
  
  if (contactData.organization_website && !validateUrl(contactData.organization_website)) {
    document.getElementById('organizationWebsite').classList.add('error');
    document.getElementById('websiteError').style.display = 'block';
    hasErrors = true;
  }
  
  if (contactData.application_url && !validateUrl(contactData.application_url)) {
    document.getElementById('applicationUrl').classList.add('error');
    document.getElementById('appUrlError').style.display = 'block';
    hasErrors = true;
  }
  
  if (hasErrors) {
    showToast('Please fix the validation errors');
    return;
  }
  
  try {
    const response = await fetch(`/api/grants/${grantId}/contact`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(contactData)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showToast('Contact information updated successfully!');
      // Reload page to show updated data
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      showToast(result.error || 'Failed to update contact information');
    }
  } catch (error) {
    console.error('Error saving contact info:', error);
    showToast('Error saving contact information');
  }
}

function saveGrant(grantId) {
  // Add save functionality here
  showToast('Grant saved successfully!');
}

function createApplication(grantId) {
  // Add application creation functionality here
  showToast('Application creation coming soon!');
}

function showToast(message) {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  toastMessage.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => {
    toast.style.display = 'none';
  }, 3000);
}
</script>
{% endblock %}