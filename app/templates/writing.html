{% extends "base.html" %}
{% block title %}Writing · Pink Lemonade{% endblock %}
{% block content %}
  <h1>Writing</h1>

  <section class="card">
    <h2>Create documents</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <button class="btn btn-primary" id="btnCase">Generate Case for Support</button>
      <button class="btn" id="btnPitch">Generate Grant Pitch</button>
      <button class="btn" id="btnReport">Generate Impact Report</button>
    </div>
    <div id="toast" class="card" style="display:none;padding:10px;margin-top:12px;background:var(--pink);color:var(--black)"></div>
  </section>

  <section id="needs" class="card" style="margin-top:16px;display:none">
    <h2>Needs input</h2>
    <ul id="needsList" style="margin-top:8px"></ul>
    <p style="margin-top:8px;color:#777;font-size:12px">Add the missing info in Settings or your Org profile, then regenerate.</p>
  </section>

  <section id="output" class="card" style="margin-top:16px;display:none">
    <h2>Output</h2>
    <div id="doc" style="white-space:pre-wrap"></div>
    <div id="exports" style="margin-top:12px;display:none">
      <a id="btnPDF" class="btn" href="#" target="_blank">Export PDF</a>
      <a id="btnDOCX" class="btn" href="#" target="_blank" style="margin-left:8px">Export Word</a>
    </div>
  </section>

  <script>
    const t = document.getElementById('toast');
    const needs = document.getElementById('needs');
    const needsList = document.getElementById('needsList');
    const out = document.getElementById('output');
    const docDiv = document.getElementById('doc');
    const exportsDiv = document.getElementById('exports');
    const btnPDF = document.getElementById('btnPDF');
    const btnDOCX = document.getElementById('btnDOCX');

    let lastDoc = { type:null, id:null };

    function show(msg){ t.style.display='block'; t.textContent=msg; }
    function showNeeds(items){
      if(items && items.length){
        needs.style.display='block';
        needsList.innerHTML = items.map(i => '<li>- '+i+'</li>').join('');
      } else {
        needs.style.display='none';
        needsList.innerHTML = '';
      }
    }
    function enableExports(type, id){
      lastDoc = { type, id };
      exportsDiv.style.display='block';
      btnPDF.href = `/api/exports/${type}/${id}?format=pdf`;
      btnDOCX.href = `/api/exports/${type}/${id}?format=docx`;
    }

    async function postJSON(url, payload){
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if(!res.ok){ throw new Error(await res.text()); }
      return res.json();
    }
    const common = { orgId: 1, orgName: 'Nitrogen Network' };

    document.getElementById('btnCase').onclick = async () => {
      // Redirect to the detailed form
      window.location.href = '/case-support';
    };

    document.getElementById('btnPitch').onclick = async () => {
      try{
        show('Generating Grant Pitch…');
        const data = await postJSON('/api/writing/grant-pitch', {...common, funder:'Target Funder', alignment:'AI literacy; workforce; community; digital divide', limits:'120'});
        out.style.display='block'; docDiv.textContent = data.content;
        showNeeds(data.needsInput);
        enableExports('grant-pitch', data.id);
        show(data.needsInput?.length ? 'Needs input listed below.' : 'Done. Copy ready.');
      }catch(e){ show('Error: '+e.message); }
    };

    document.getElementById('btnReport').onclick = async () => {
      try{
        show('Generating Impact Report…');
        const data = await postJSON('/api/writing/impact-report', {...common, startDate:'2025-01-01', endDate:'2025-06-30'});
        out.style.display='block'; docDiv.textContent = data.content;
        showNeeds(data.needsUpdate);
        enableExports('impact-report', data.id);
        show(data.needsUpdate?.length ? 'Needs update listed below.' : 'Done. Copy ready.');
      }catch(e){ show('Error: '+e.message); }
    };
  </script>
{% endblock %}