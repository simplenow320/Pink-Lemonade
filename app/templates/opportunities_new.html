{% extends "base.html" %}
{% block title %}Discover Opportunities{% endblock %}
{% block content %}

<!-- Hero Header -->
<div style="background:#FAFAFA;padding:60px 20px;text-align:center;margin-bottom:40px">
  <h1 style="font-size:2.8rem;font-weight:500;color:#2A2A2A;margin:0 0 16px 0;letter-spacing:-0.01em">
    Discover Grant Opportunities
  </h1>
  <p style="font-size:1.1rem;color:#6B6B6B;max-width:600px;margin:0 auto">
    Find and track funding opportunities that match your organization's mission
  </p>
</div>

<!-- Search and Filters -->
<div style="background:white;border-radius:20px;padding:32px;box-shadow:0 2px 10px rgba(0,0,0,0.04);margin-bottom:32px;border:1px solid #E8E8E8">
  
  <!-- Search Bar -->
  <div style="margin-bottom:32px">
    <div style="position:relative;max-width:600px;margin:0 auto">
      <div style="position:absolute;left:16px;top:50%;transform:translateY(-50%);pointer-events:none">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#6B6B6B">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
      </div>
      <input id="searchInput" name="search" placeholder="Search by title, funder, or keyword..." 
        style="width:100%;padding:16px 16px 16px 50px;border-radius:50px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:1rem;outline:none;transition:all 0.2s ease"
        onfocus="this.style.borderColor='#B8899A';this.style.boxShadow='0 0 0 3px rgba(184,137,154,0.1)'"
        onblur="this.style.borderColor='#E8E8E8';this.style.boxShadow='none'">
    </div>
  </div>

  <!-- Filters -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:24px">
    
    <div>
      <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">City</label>
      <select id="cityFilter" name="city" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
        <option value="">All Cities</option>
        <option value="New York">New York</option>
        <option value="Chicago">Chicago</option>
        <option value="Los Angeles">Los Angeles</option>
        <option value="Houston">Houston</option>
        <option value="Philadelphia">Philadelphia</option>
        <option value="Detroit">Detroit</option>
        <option value="Atlanta">Atlanta</option>
      </select>
    </div>
    
    <div>
      <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Focus Area</label>
      <select id="focusFilter" name="focus_area" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
        <option value="">All Areas</option>
        <option value="Youth Development">Youth Development</option>
        <option value="Community Development">Community Development</option>
        <option value="Family Services">Family Services</option>
        <option value="Food Security">Food Security</option>
        <option value="Education">Education</option>
        <option value="Health">Health & Wellness</option>
        <option value="Housing">Housing</option>
        <option value="Arts">Arts & Culture</option>
      </select>
    </div>
    
    <div>
      <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Deadline</label>
      <select id="deadlineFilter" name="deadline_days" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
        <option value="">Any Time</option>
        <option value="7">Next 7 Days</option>
        <option value="30">Next 30 Days</option>
        <option value="60">Next 60 Days</option>
        <option value="90">Next 90 Days</option>
      </select>
    </div>
    
    <div>
      <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Source</label>
      <select id="sourceFilter" name="source" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
        <option value="all">All Government Sources</option>
        <option value="federal_register">Federal Register</option>
        <option value="usaspending">USAspending.gov</option>
      </select>
    </div>
    
  </div>

  <!-- Action Buttons -->
  <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
    <button id="searchBtn" style="background:#B8899A;color:white;padding:12px 24px;border-radius:24px;border:none;font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(184,137,154,0.2)"
      onmouseover="this.style.background='#A67A8A';this.style.transform='translateY(-1px)'"
      onmouseout="this.style.background='#B8899A';this.style.transform='translateY(0)'">
      Search Grants
    </button>
    <button id="discoverBtn" style="background:white;color:#B8899A;padding:12px 24px;border-radius:24px;border:1px solid #B8899A;font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
      onmouseover="this.style.background='#B8899A';this.style.color='white'"
      onmouseout="this.style.background='white';this.style.color='#B8899A'">
      Discover New Grants
    </button>
    <button id="clearFilters" style="background:transparent;color:#6B6B6B;padding:12px 24px;border-radius:24px;border:1px solid #E8E8E8;font-size:0.95rem;cursor:pointer;transition:all 0.2s ease"
      onmouseover="this.style.background='#F5F5F5'"
      onmouseout="this.style.background='transparent'">
      Clear Filters
    </button>
  </div>
</div>

<!-- Results Summary -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
  <h2 id="resultCount" style="font-size:1.4rem;font-weight:500;color:#2A2A2A;margin:0">
    <span id="resultCountNumber">0</span> Opportunities Found
  </h2>
  <div style="display:flex;align-items:center;gap:12px">
    <span style="color:#6B6B6B;font-size:0.9rem">Sort by:</span>
    <select id="sortBy" style="padding:8px 12px;border-radius:8px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.9rem">
      <option value="deadline">Deadline</option>
      <option value="fit_score">Best Match</option>
      <option value="amount">Amount</option>
      <option value="recent">Most Recent</option>
    </select>
  </div>
</div>

<!-- Loading State -->
<div id="loadingState" style="display:none;text-align:center;padding:60px 20px">
  <div style="display:inline-block;width:40px;height:40px;border:3px solid #E8E8E8;border-radius:50%;border-top-color:#B8899A;animation:spin 1s ease-in-out infinite;margin-bottom:16px"></div>
  <p style="color:#6B6B6B;margin:0">Searching for opportunities...</p>
</div>

<!-- Results Grid -->
<div id="opportunitiesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:24px">
  <!-- Opportunities will be loaded here -->
</div>

<!-- Empty State -->
<div id="emptyState" style="display:none;text-align:center;padding:80px 20px;color:#6B6B6B">
  <div style="width:80px;height:80px;background:#F5F0F1;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px">
    <svg width="36" height="36" viewBox="0 0 24 24" fill="#B8899A">
      <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </svg>
  </div>
  <h3 style="font-size:1.3rem;font-weight:500;color:#2A2A2A;margin:0 0 8px 0">No opportunities found</h3>
  <p style="margin:0 0 24px 0">Try adjusting your search criteria or discover new grants</p>
  <button id="discoverEmptyBtn" style="background:#B8899A;color:white;padding:12px 24px;border-radius:24px;border:none;font-size:0.95rem;font-weight:500;cursor:pointer">
    Discover Grants
  </button>
</div>

<!-- Toast Notification -->
<div id="toast" style="display:none;position:fixed;top:20px;right:20px;background:#B8899A;color:white;padding:16px 24px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:1000;font-size:0.9rem;font-weight:500">
  <span id="toastMessage">Notification</span>
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced select styling */
select:focus {
  outline: none;
  border-color: #B8899A !important;
  box-shadow: 0 0 0 3px rgba(184,137,154,0.1) !important;
}
</style>

<script>
// State management
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};
let opportunities = [];

// DOM elements
const searchInput = document.getElementById('searchInput');
const clearBtn = document.getElementById('clearFilters');
const discoverBtn = document.getElementById('discoverBtn');
const discoverEmptyBtn = document.getElementById('discoverEmptyBtn');
const searchBtn = document.getElementById('searchBtn');
const loadingState = document.getElementById('loadingState');
const emptyState = document.getElementById('emptyState');
const opportunitiesGrid = document.getElementById('opportunitiesGrid');
const resultCountNumber = document.getElementById('resultCountNumber');
const sortBy = document.getElementById('sortBy');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadOpportunities();
});

// Clear filters
clearBtn.addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('cityFilter').value = '';
    document.getElementById('focusFilter').value = '';
    document.getElementById('deadlineFilter').value = '';
    document.getElementById('sourceFilter').value = '';
    currentPage = 1;
    loadOpportunities();
});

// Sort change
sortBy.addEventListener('change', () => {
    sortOpportunities();
    renderOpportunities();
});

// Search functionality
searchBtn.addEventListener('click', (e) => {
    e.preventDefault();
    currentPage = 1;
    loadOpportunities();
});

// Discover grants functionality
async function discoverGrants() {
    const activeBtn = event.target;
    const originalText = activeBtn.textContent;
    
    activeBtn.disabled = true;
    activeBtn.textContent = 'Discovering...';
    showLoading();
    
    try {
        const response = await fetch('/api/scrape/run-now', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                orgId: {{ org_id|default(1)|int }},
                query: searchInput.value || null
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast(`Found ${data.upserted || 0} new opportunities (${data.mode || 'live'})`);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Discovery failed');
        }
        
    } catch (error) {
        showToast('Discovery failed. Please try again.', true);
        hideLoading();
    } finally {
        activeBtn.disabled = false;
        activeBtn.textContent = originalText;
    }
}

// Event listeners for discovery buttons
if (discoverBtn) {
    discoverBtn.addEventListener('click', discoverGrants);
}

if (discoverEmptyBtn) {
    discoverEmptyBtn.addEventListener('click', discoverGrants);
}

// Load opportunities from API
async function loadOpportunities() {
    showLoading();
    
    // Get form data
    const params = new URLSearchParams();
    
    if (searchInput.value) params.append('search', searchInput.value);
    if (document.getElementById('cityFilter').value) params.append('city', document.getElementById('cityFilter').value);
    if (document.getElementById('focusFilter').value) params.append('focus_area', document.getElementById('focusFilter').value);
    if (document.getElementById('deadlineFilter').value) params.append('deadline_days', document.getElementById('deadlineFilter').value);
    if (document.getElementById('sourceFilter').value) params.append('source', document.getElementById('sourceFilter').value);
    
    params.append('page', currentPage);
    
    try {
        const response = await fetch(`/api/live-grants/search?${params.toString()}`);
        const data = await response.json();
        
        opportunities = data.grants || data.opportunities || [];
        totalPages = data.total_pages || 1;
        
        // Update UI
        resultCountNumber.textContent = data.total || 0;
        
        // Show data source message if this is live data
        if (data.is_live_data) {
            console.log('Displaying real government grant data from:', data.sources_queried);
        }
        
        if (opportunities.length > 0) {
            sortOpportunities();
            renderOpportunities();
            emptyState.style.display = 'none';
            opportunitiesGrid.style.display = 'grid';
        } else {
            emptyState.style.display = 'block';
            opportunitiesGrid.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading opportunities:', error);
        showToast('Failed to load opportunities. Please try again.', true);
        emptyState.style.display = 'block';
        opportunitiesGrid.style.display = 'none';
    } finally {
        hideLoading();
    }
}

// Sort opportunities
function sortOpportunities() {
    const sortValue = sortBy.value;
    
    opportunities.sort((a, b) => {
        switch (sortValue) {
            case 'deadline':
                return (a.deadline || '9999-12-31').localeCompare(b.deadline || '9999-12-31');
            case 'fit_score':
                return (b.fit_score || 0) - (a.fit_score || 0);
            case 'amount':
                return (b.amount_max || 0) - (a.amount_max || 0);
            case 'recent':
                return (b.id || 0) - (a.id || 0);
            default:
                return 0;
        }
    });
}

// Render opportunities
function renderOpportunities() {
    opportunitiesGrid.innerHTML = opportunities.map(opp => createOpportunityCard(opp)).join('');
}

// Create opportunity card HTML
function createOpportunityCard(opp) {
    const deadline = opp.deadline ? new Date(opp.deadline).toLocaleDateString() : 'Rolling';
    const amount = formatAmount(opp.amount_min, opp.amount_max);
    const fitBadge = opp.fit_score ? getFitBadge(opp.fit_score) : '';
    
    return `
        <div style="background:white;border-radius:16px;padding:24px;border:1px solid #E8E8E8;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(0,0,0,0.02)"
          onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.08)'"
          onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.02)'">
          
          <!-- Grant Header -->
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
              <h3 style="font-size:1.2rem;font-weight:600;color:#2A2A2A;margin:0;line-height:1.3;flex:1;padding-right:16px">
                <a href="/grant/${opp.id}" style="color:inherit;text-decoration:none">${escapeHtml(opp.title)}</a>
              </h3>
              ${fitBadge}
            </div>
            <p style="color:#6B6B6B;margin:0;font-size:0.95rem;font-weight:500">${escapeHtml(opp.funder)}</p>
          </div>

          <!-- Grant Details -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;font-size:0.9rem">
            <div>
              <div style="color:#6B6B6B;margin-bottom:4px">Amount</div>
              <div style="color:#2A2A2A;font-weight:500">${amount}</div>
            </div>
            <div>
              <div style="color:#6B6B6B;margin-bottom:4px">Deadline</div>
              <div style="color:#2A2A2A;font-weight:500">${deadline}</div>
            </div>
          </div>

          <!-- Actions -->
          <div style="display:flex;gap:8px">
            <button onclick="saveOpportunity(${opp.id})" style="background:white;color:#B8899A;padding:10px 16px;border:1px solid #B8899A;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:500;transition:all 0.2s ease"
              onmouseover="this.style.background='#B8899A';this.style.color='white'"
              onmouseout="this.style.background='white';this.style.color='#B8899A'">
              Save
            </button>
            <button onclick="applyToOpportunity(${opp.id})" style="flex:1;background:#B8899A;color:white;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:0.9rem;font-weight:500;transition:all 0.2s ease"
              onmouseover="this.style.background='#A67A8A'"
              onmouseout="this.style.background='#B8899A'">
              Apply
            </button>
          </div>
        </div>
    `;
}

// Get fit score badge
function getFitBadge(score) {
    return `
        <div style="background:linear-gradient(135deg,#B8899A,#D4BAC7);color:white;padding:6px 12px;border-radius:20px;font-size:0.8rem;font-weight:600;min-width:fit-content">
          ${score}/5 â˜…
        </div>
    `;
}

// Format amount
function formatAmount(min, max) {
    if (min && max) {
        return `$${formatNumber(min)} - $${formatNumber(max)}`;
    } else if (min) {
        return `$${formatNumber(min)}+`;
    } else if (max) {
        return `Up to $${formatNumber(max)}`;
    }
    return 'Not specified';
}

// Format number with commas
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Show/hide loading
function showLoading() {
    loadingState.style.display = 'block';
    emptyState.style.display = 'none';
    opportunitiesGrid.style.display = 'none';
}

function hideLoading() {
    loadingState.style.display = 'none';
}

// Show toast notification
function showToast(message, isError = false) {
    toastMessage.textContent = message;
    toast.style.background = isError ? '#EF4444' : '#B8899A';
    toast.style.display = 'block';
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

// Action functions (placeholders)
function saveOpportunity(id) {
    showToast('Grant saved successfully!');
}

function applyToOpportunity(id) {
    window.location.href = `/grant/${id}`;
}
</script>
{% endblock %}