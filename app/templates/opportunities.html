{% extends "base.html" %}

{% block title %}Grant Opportunities - Pink Lemonade{% endblock %}

{% block content %}
<div style="min-height:100vh;background:linear-gradient(135deg,#FAFAFA 0%,#F5F5F5 100%);padding:80px 20px 40px">
  <div style="max-width:1200px;margin:0 auto">
    
    <!-- Header -->
    <div style="text-align:center;margin-bottom:40px">
      <h1 style="font-size:2.5rem;font-weight:700;color:#2A2A2A;margin:0 0 12px 0;line-height:1.2">
        Grant Opportunities
      </h1>
      <p style="color:#6B6B6B;font-size:1.1rem;margin:0;max-width:600px;margin:0 auto">
        Access 259,000+ foundations and federal grants. Our AI matches your organization with the best funding opportunities.
      </p>
    </div>

    <!-- Search Bar -->
    <div style="position:relative;margin-bottom:32px;max-width:600px;margin-left:auto;margin-right:auto">
      <div style="position:absolute;left:16px;top:50%;transform:translateY(-50%);z-index:1">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#6B6B6B">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
      </div>
      <input id="q" name="q" placeholder="Search by title, funder, or keyword..." 
        style="width:100%;padding:16px 16px 16px 50px;border-radius:50px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:1rem;outline:none;transition:all 0.2s ease"
        onfocus="this.style.borderColor='#B8899A';this.style.boxShadow='0 0 0 3px rgba(184,137,154,0.1)'"
        onblur="this.style.borderColor='#E8E8E8';this.style.boxShadow='none'">
    </div>

    <!-- Comprehensive Filter Section -->
    <div style="background:white;border-radius:16px;padding:24px;margin-bottom:32px;box-shadow:0 2px 12px rgba(0,0,0,0.06);border:1px solid #F0F0F0">
      <h3 style="margin:0 0 20px 0;color:#2A2A2A;font-size:1.1rem;font-weight:600">Filter Your Search</h3>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px">
        
        <!-- Location Filter - All US States -->
        <div>
          <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Location</label>
          <select id="locationFilter" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
            <option value="">All Locations</option>
            <option value="nationwide">Nationwide</option>
            <optgroup label="States">
              <option value="alabama">Alabama</option>
              <option value="alaska">Alaska</option>
              <option value="arizona">Arizona</option>
              <option value="arkansas">Arkansas</option>
              <option value="california">California</option>
              <option value="colorado">Colorado</option>
              <option value="connecticut">Connecticut</option>
              <option value="delaware">Delaware</option>
              <option value="florida">Florida</option>
              <option value="georgia">Georgia</option>
              <option value="hawaii">Hawaii</option>
              <option value="idaho">Idaho</option>
              <option value="illinois">Illinois</option>
              <option value="indiana">Indiana</option>
              <option value="iowa">Iowa</option>
              <option value="kansas">Kansas</option>
              <option value="kentucky">Kentucky</option>
              <option value="louisiana">Louisiana</option>
              <option value="maine">Maine</option>
              <option value="maryland">Maryland</option>
              <option value="massachusetts">Massachusetts</option>
              <option value="michigan">Michigan</option>
              <option value="minnesota">Minnesota</option>
              <option value="mississippi">Mississippi</option>
              <option value="missouri">Missouri</option>
              <option value="montana">Montana</option>
              <option value="nebraska">Nebraska</option>
              <option value="nevada">Nevada</option>
              <option value="new_hampshire">New Hampshire</option>
              <option value="new_jersey">New Jersey</option>
              <option value="new_mexico">New Mexico</option>
              <option value="new_york">New York</option>
              <option value="north_carolina">North Carolina</option>
              <option value="north_dakota">North Dakota</option>
              <option value="ohio">Ohio</option>
              <option value="oklahoma">Oklahoma</option>
              <option value="oregon">Oregon</option>
              <option value="pennsylvania">Pennsylvania</option>
              <option value="rhode_island">Rhode Island</option>
              <option value="south_carolina">South Carolina</option>
              <option value="south_dakota">South Dakota</option>
              <option value="tennessee">Tennessee</option>
              <option value="texas">Texas</option>
              <option value="utah">Utah</option>
              <option value="vermont">Vermont</option>
              <option value="virginia">Virginia</option>
              <option value="washington">Washington</option>
              <option value="west_virginia">West Virginia</option>
              <option value="wisconsin">Wisconsin</option>
              <option value="wyoming">Wyoming</option>
            </optgroup>
          </select>
        </div>

        <!-- Comprehensive Focus Areas -->
        <div>
          <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Focus Area</label>
          <select id="focusAreaFilter" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
            <option value="">All Focus Areas</option>
            <optgroup label="Major Categories">
              <option value="arts_culture">Arts & Culture</option>
              <option value="education">Education</option>
              <option value="health_medical">Health & Medical</option>
              <option value="human_services">Human Services</option>
              <option value="environment">Environment</option>
              <option value="public_benefit">Public Benefit</option>
              <option value="religion">Religion & Faith</option>
              <option value="international">International</option>
            </optgroup>
            <optgroup label="Specialized Areas">
              <option value="youth_development">Youth Development</option>
              <option value="senior_services">Senior Services</option>
              <option value="disability_services">Disability Services</option>
              <option value="housing_shelter">Housing & Shelter</option>
              <option value="food_nutrition">Food & Nutrition</option>
              <option value="mental_health">Mental Health</option>
              <option value="substance_abuse">Substance Abuse</option>
              <option value="domestic_violence">Domestic Violence</option>
              <option value="criminal_justice">Criminal Justice</option>
              <option value="economic_development">Economic Development</option>
              <option value="research">Research & Science</option>
              <option value="technology">Technology</option>
              <option value="community_development">Community Development</option>
              <option value="disaster_relief">Disaster Relief</option>
            </optgroup>
            <optgroup label="Urban Ministry Focus">
              <option value="urban_ministry">Urban Ministry</option>
              <option value="inner_city">Inner City Programs</option>
              <option value="community_organizing">Community Organizing</option>
              <option value="social_justice">Social Justice</option>
            </optgroup>
          </select>
        </div>

        <!-- Funding Amount -->
        <div>
          <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Funding Amount</label>
          <select id="amountFilter" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
            <option value="">Any Amount</option>
            <option value="under_10k">Under $10,000</option>
            <option value="10k_25k">$10,000 - $25,000</option>
            <option value="25k_50k">$25,000 - $50,000</option>
            <option value="50k_100k">$50,000 - $100,000</option>
            <option value="100k_250k">$100,000 - $250,000</option>
            <option value="250k_500k">$250,000 - $500,000</option>
            <option value="500k_1m">$500,000 - $1,000,000</option>
            <option value="over_1m">Over $1,000,000</option>
          </select>
        </div>

        <!-- Deadline Filter -->
        <div>
          <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Deadline</label>
          <select id="deadlineFilter" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
            <option value="">Any Time</option>
            <option value="30">Next 30 Days</option>
            <option value="60">Next 60 Days</option>
            <option value="90">Next 90 Days</option>
            <option value="6months">Next 6 Months</option>
            <option value="rolling">Rolling Deadlines</option>
          </select>
        </div>

        <!-- Updated Source Filter - Shows Our Real Capabilities -->
        <div>
          <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Source</label>
          <select id="sourceFilter" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
            <option value="">All Sources</option>
            <option value="candid_foundations">🏆 Candid Foundation Database (259,000 foundations)</option>
            <option value="federal_grants">Federal Grants (Government)</option>
            <option value="candid_news">Foundation News & RFPs</option>
            <option value="historical_awards">Historical Grant Awards</option>
            <option value="major_foundations">Major Foundations Directory</option>
            <option value="saved_grants">Your Saved Grants</option>
          </select>
        </div>

        <!-- Grant Type -->
        <div>
          <label style="display:block;margin-bottom:8px;font-weight:500;color:#2A2A2A;font-size:0.9rem">Grant Type</label>
          <select id="typeFilter" style="width:100%;padding:12px;border-radius:12px;border:1px solid #E8E8E8;background:#FAFAFA;color:#2A2A2A;font-size:0.95rem">
            <option value="">All Types</option>
            <option value="general_operating">General Operating Support</option>
            <option value="program_specific">Program-Specific</option>
            <option value="capacity_building">Capacity Building</option>
            <option value="capital_campaign">Capital Campaign</option>
            <option value="emergency_relief">Emergency Relief</option>
            <option value="research_project">Research Project</option>
            <option value="planning_grant">Planning Grant</option>
            <option value="multi_year">Multi-Year Funding</option>
          </select>
        </div>

      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:40px">
      <button id="searchBtn" style="background:#B8899A;color:white;padding:12px 24px;border-radius:24px;border:none;font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(184,137,154,0.2)"
        onmouseover="this.style.background='#A67A8A';this.style.transform='translateY(-1px)'"
        onmouseout="this.style.background='#B8899A';this.style.transform='translateY(0)'">
        🔍 Search Grants
      </button>
      
      <button id="aiMatchBtn" style="background:#2A2A2A;color:white;padding:12px 24px;border-radius:24px;border:none;font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(42,42,42,0.2)"
        onmouseover="this.style.background='#1A1A1A';this.style.transform='translateY(-1px)'"
        onmouseout="this.style.background='#2A2A2A';this.style.transform='translateY(0)'">
        🤖 AI Smart Match
      </button>
      
      <button id="clearFiltersBtn" style="background:white;color:#6B6B6B;padding:12px 24px;border-radius:24px;border:1px solid #E8E8E8;font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
        onmouseover="this.style.borderColor='#B8899A';this.style.color='#B8899A'"
        onmouseout="this.style.borderColor='#E8E8E8';this.style.color='#6B6B6B'">
        Clear All Filters
      </button>
    </div>

    <!-- Results Section -->
    <div id="resultsContainer" style="display:none">
      <!-- Loading State -->
      <div id="loadingState" style="text-align:center;padding:60px 20px;display:none">
        <div style="width:50px;height:50px;border:3px solid #E8E8E8;border-top:3px solid #B8899A;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px"></div>
        <p style="color:#6B6B6B;font-size:1rem">Searching 259,000+ foundations and federal grants...</p>
      </div>
      
      <!-- Results -->
      <div id="grants-list"></div>
    </div>

    <!-- Initial State Message -->
    <div id="initialState" style="text-align:center;padding:60px 20px;background:white;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06)">
      <div style="margin-bottom:24px">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="#B8899A" style="margin:0 auto;display:block">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
      </div>
      <h3 style="margin:0 0 12px 0;color:#2A2A2A;font-size:1.3rem;font-weight:600">Ready to Find Your Perfect Grant?</h3>
      <p style="color:#6B6B6B;font-size:1rem;margin:0 0 24px 0;max-width:500px;margin-left:auto;margin-right:auto">
        Use our filters to narrow down from 259,000+ foundations and federal grants, or let our AI find the best matches for your organization.
      </p>
      <p style="color:#B8899A;font-size:0.9rem;font-weight:500">
        💡 Pro Tip: Try the AI Smart Match for personalized recommendations based on your organization profile
      </p>
    </div>

  </div>
</div>

<!-- CSS Animations -->
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .filter-grid {
    grid-template-columns: 1fr !important;
  }
  
  h1 {
    font-size: 2rem !important;
  }
}
</style>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('searchBtn');
    const aiMatchBtn = document.getElementById('aiMatchBtn');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const initialState = document.getElementById('initialState');
    const loadingState = document.getElementById('loadingState');
    const grantsList = document.getElementById('grants-list');

    // Auto-populate filters from user profile if available
    loadUserPreferences();

    // Search functionality
    searchBtn.addEventListener('click', performSearch);
    aiMatchBtn.addEventListener('click', performAIMatch);
    clearFiltersBtn.addEventListener('click', clearAllFilters);

    // Enter key support for search
    document.getElementById('q').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    function loadUserPreferences() {
        // Auto-populate location and focus area from organization profile
        fetch('/api/organization/profile')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.organization) {
                    const org = data.organization;
                    
                    // Auto-select location if available
                    if (org.location) {
                        const locationSelect = document.getElementById('locationFilter');
                        const locationValue = org.location.toLowerCase().replace(/\s+/g, '_');
                        const option = locationSelect.querySelector(`option[value="${locationValue}"]`);
                        if (option) {
                            locationSelect.value = locationValue;
                        }
                    }
                    
                    // Auto-select primary focus area if available
                    if (org.focus_areas && org.focus_areas.length > 0) {
                        const focusSelect = document.getElementById('focusAreaFilter');
                        const primaryFocus = org.focus_areas[0].toLowerCase().replace(/\s+/g, '_');
                        const option = focusSelect.querySelector(`option[value="${primaryFocus}"]`);
                        if (option) {
                            focusSelect.value = primaryFocus;
                        }
                    }
                }
            })
            .catch(error => console.log('No profile data available'));
    }

    function performSearch() {
        showLoading();
        
        const searchData = {
            query: document.getElementById('q').value,
            location: document.getElementById('locationFilter').value,
            focus_area: document.getElementById('focusAreaFilter').value,
            amount: document.getElementById('amountFilter').value,
            deadline: document.getElementById('deadlineFilter').value,
            source: document.getElementById('sourceFilter').value,
            type: document.getElementById('typeFilter').value
        };

        fetch('/api/opportunities/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(searchData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            displayResults(data.grants || []);
        })
        .catch(error => {
            hideLoading();
            showError('Error searching grants. Please try again.');
        });
    }

    function performAIMatch() {
        showLoading();
        
        fetch('/api/ai-grants/match', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                use_profile: true,
                include_explanations: true
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            displayAIResults(data.matches || []);
        })
        .catch(error => {
            hideLoading();
            showError('Error getting AI recommendations. Please try again.');
        });
    }

    function clearAllFilters() {
        document.getElementById('q').value = '';
        document.getElementById('locationFilter').value = '';
        document.getElementById('focusAreaFilter').value = '';
        document.getElementById('amountFilter').value = '';
        document.getElementById('deadlineFilter').value = '';
        document.getElementById('sourceFilter').value = '';
        document.getElementById('typeFilter').value = '';
        
        hideResults();
    }

    function showLoading() {
        initialState.style.display = 'none';
        resultsContainer.style.display = 'block';
        loadingState.style.display = 'block';
        grantsList.style.display = 'none';
    }

    function hideLoading() {
        loadingState.style.display = 'none';
        grantsList.style.display = 'block';
    }

    function hideResults() {
        resultsContainer.style.display = 'none';
        initialState.style.display = 'block';
    }

    function displayResults(grants) {
        if (grants.length === 0) {
            grantsList.innerHTML = `
                <div style="text-align:center;padding:40px;background:white;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06)">
                    <p style="color:#6B6B6B;font-size:1rem">No grants found matching your criteria. Try adjusting your filters or using broader search terms.</p>
                </div>
            `;
            return;
        }

        const grantsHTML = grants.map(grant => `
            <div style="background:white;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,0.06);border:1px solid #F0F0F0;transition:all 0.2s ease"
                 onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 20px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 12px rgba(0,0,0,0.06)'">
                
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                    <h3 style="margin:0;color:#2A2A2A;font-size:1.2rem;font-weight:600;flex:1;margin-right:20px">
                        ${grant.title || 'Grant Opportunity'}
                    </h3>
                    ${grant.amount ? `<span style="background:#E8F5E8;color:#2D5A2D;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:500;white-space:nowrap">${grant.amount}</span>` : ''}
                </div>
                
                <div style="margin-bottom:16px">
                    <p style="color:#6B6B6B;font-size:0.95rem;margin:0 0 8px 0">
                        <strong style="color:#2A2A2A">Funder:</strong> ${grant.funder || 'Not specified'}
                    </p>
                    ${grant.deadline ? `<p style="color:#6B6B6B;font-size:0.95rem;margin:0 0 8px 0">
                        <strong style="color:#2A2A2A">Deadline:</strong> ${grant.deadline}
                    </p>` : ''}
                    ${grant.location ? `<p style="color:#6B6B6B;font-size:0.95rem;margin:0">
                        <strong style="color:#2A2A2A">Location:</strong> ${grant.location}
                    </p>` : ''}
                </div>
                
                ${grant.description ? `<p style="color:#6B6B6B;font-size:0.95rem;line-height:1.5;margin:0 0 20px 0">${grant.description}</p>` : ''}
                
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                    <button onclick="viewGrant('${grant.id || ''}')" 
                            style="background:#B8899A;color:white;padding:8px 16px;border-radius:20px;border:none;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
                            onmouseover="this.style.background='#A67A8A'"
                            onmouseout="this.style.background='#B8899A'">
                        View Details
                    </button>
                    <button onclick="saveGrant('${grant.id || ''}')" 
                            style="background:white;color:#B8899A;padding:8px 16px;border-radius:20px;border:1px solid #B8899A;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
                            onmouseover="this.style.background='#B8899A';this.style.color='white'"
                            onmouseout="this.style.background='white';this.style.color='#B8899A'">
                        💾 Save
                    </button>
                    ${grant.source ? `<span style="color:#6B6B6B;font-size:0.85rem;margin-left:auto">${grant.source}</span>` : ''}
                </div>
            </div>
        `).join('');

        grantsList.innerHTML = `
            <div style="margin-bottom:20px;text-align:center">
                <p style="color:#6B6B6B;font-size:0.95rem">Found ${grants.length} grant${grants.length === 1 ? '' : 's'} matching your criteria</p>
            </div>
            ${grantsHTML}
        `;
    }

    function displayAIResults(matches) {
        if (matches.length === 0) {
            grantsList.innerHTML = `
                <div style="text-align:center;padding:40px;background:white;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06)">
                    <p style="color:#6B6B6B;font-size:1rem">No AI matches found. Please complete your organization profile for better recommendations.</p>
                </div>
            `;
            return;
        }

        const matchesHTML = matches.map(match => `
            <div style="background:white;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,0.06);border:1px solid #F0F0F0;transition:all 0.2s ease"
                 onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 20px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 12px rgba(0,0,0,0.06)'">
                
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                    <h3 style="margin:0;color:#2A2A2A;font-size:1.2rem;font-weight:600;flex:1;margin-right:20px">
                        ${match.grant?.title || 'Grant Opportunity'}
                    </h3>
                    <div style="display:flex;gap:8px;align-items:center">
                        ${match.score ? `<span style="background:#E8F5E8;color:#2D5A2D;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:500">
                            ${match.score}/5 ⭐
                        </span>` : ''}
                        ${match.grant?.amount ? `<span style="background:#E8F5E8;color:#2D5A2D;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:500">${match.grant.amount}</span>` : ''}
                    </div>
                </div>
                
                ${match.explanation ? `
                    <div style="background:#F8F9FA;border-radius:12px;padding:16px;margin-bottom:16px">
                        <h4 style="margin:0 0 8px 0;color:#2A2A2A;font-size:0.95rem;font-weight:600">🤖 AI Analysis</h4>
                        <p style="color:#6B6B6B;font-size:0.9rem;line-height:1.5;margin:0">${match.explanation}</p>
                    </div>
                ` : ''}
                
                <div style="margin-bottom:16px">
                    <p style="color:#6B6B6B;font-size:0.95rem;margin:0 0 8px 0">
                        <strong style="color:#2A2A2A">Funder:</strong> ${match.grant?.funder || 'Not specified'}
                    </p>
                    ${match.grant?.deadline ? `<p style="color:#6B6B6B;font-size:0.95rem;margin:0 0 8px 0">
                        <strong style="color:#2A2A2A">Deadline:</strong> ${match.grant.deadline}
                    </p>` : ''}
                    ${match.grant?.location ? `<p style="color:#6B6B6B;font-size:0.95rem;margin:0">
                        <strong style="color:#2A2A2A">Location:</strong> ${match.grant.location}
                    </p>` : ''}
                </div>
                
                ${match.grant?.description ? `<p style="color:#6B6B6B;font-size:0.95rem;line-height:1.5;margin:0 0 20px 0">${match.grant.description}</p>` : ''}
                
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                    <button onclick="viewGrant('${match.grant?.id || ''}')" 
                            style="background:#B8899A;color:white;padding:8px 16px;border-radius:20px;border:none;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
                            onmouseover="this.style.background='#A67A8A'"
                            onmouseout="this.style.background='#B8899A'">
                        View Details
                    </button>
                    <button onclick="generateProposal('${match.grant?.id || ''}')" 
                            style="background:#2A2A2A;color:white;padding:8px 16px;border-radius:20px;border:none;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
                            onmouseover="this.style.background='#1A1A1A'"
                            onmouseout="this.style.background='#2A2A2A'">
                        🤖 Generate Proposal
                    </button>
                    <button onclick="saveGrant('${match.grant?.id || ''}')" 
                            style="background:white;color:#B8899A;padding:8px 16px;border-radius:20px;border:1px solid #B8899A;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.2s ease"
                            onmouseover="this.style.background='#B8899A';this.style.color='white'"
                            onmouseout="this.style.background='white';this.style.color='#B8899A'">
                        💾 Save
                    </button>
                    ${match.grant?.source ? `<span style="color:#6B6B6B;font-size:0.85rem;margin-left:auto">${match.grant.source}</span>` : ''}
                </div>
            </div>
        `).join('');

        grantsList.innerHTML = `
            <div style="margin-bottom:20px;text-align:center">
                <p style="color:#6B6B6B;font-size:0.95rem">🤖 AI found ${matches.length} high-quality match${matches.length === 1 ? '' : 'es'} for your organization</p>
            </div>
            ${matchesHTML}
        `;
    }

    function showError(message) {
        grantsList.innerHTML = `
            <div style="text-align:center;padding:40px;background:#FFF5F5;border:1px solid #FEB2B2;border-radius:16px">
                <p style="color:#C53030;font-size:1rem">${message}</p>
            </div>
        `;
    }

    // Global functions for grant actions
    window.viewGrant = function(grantId) {
        if (grantId) {
            window.location.href = `/grants/${grantId}`;
        }
    };

    window.saveGrant = function(grantId) {
        if (grantId) {
            fetch(`/api/grants/${grantId}/save`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Grant saved successfully!');
                    }
                });
        }
    };

    window.generateProposal = function(grantId) {
        if (grantId) {
            window.location.href = `/smart-tools?grant_id=${grantId}&tool=proposal`;
        }
    };
});
</script>

{% endblock %}