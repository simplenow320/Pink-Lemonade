{% extends "base.html" %}
{% block title %}Opportunities{% endblock %}
{% block content %}
  <h1>Opportunities</h1>
  <form id="searchForm" class="card" onsubmit="return false" style="margin-bottom:16px">
    <label for="q">Search</label>
    <input id="q" name="q" placeholder="Search grants..." style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.12)">
    <div style="margin-top:12px">
      <button id="discoverBtn" class="btn btn-primary" type="button">Discover grants</button>
    </div>
  </form>
  <div id="toast" class="card" style="display:none;padding:12px;margin-bottom:12px;background:var(--pink);color:var(--black)">Updated.</div>
  <section class="grid">
    {% for g in grants %}
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">{{ g.title }}</h3>
        <span class="badge">{{ g.deadline or 'Rolling' }}</span>
      </div>
      <p style="margin:8px 0 12px 0">{{ g.funder }}</p>
      <a class="btn" href="{{ g.link }}" target="_blank">Open</a>
    </div>
    {% endfor %}
  </section>
  <script>
  const btn = document.getElementById('discoverBtn');
  const toast = document.getElementById('toast');
  const q = document.getElementById('q');
  async function runDiscovery(){
    btn.disabled = true; btn.textContent = 'Discoveringâ€¦';
    try{
      const res = await fetch('/api/scrape/run-now', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ orgId: {{ org_id|int }}, query: q.value || null })
      });
      const data = await res.json();
      toast.style.display = 'block';
      toast.textContent = `Upserted ${data.upserted || 0} opportunities (${data.mode}).`;
      setTimeout(()=>{ window.location.reload(); }, 800);
    }catch(e){
      toast.style.display = 'block';
      toast.textContent = 'Discovery failed. Please try again.';
    }finally{
      btn.disabled = false; btn.textContent = 'Discover grants';
    }
  }
  btn.addEventListener('click', runDiscovery);
  </script>
{% endblock %}